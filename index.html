<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DBS DataMatrix Generator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .preview-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .preview-box svg {
            max-width: 100%;
            max-height: 280px;
        }

        .color-input {
            width: 100%;
            height: 38px;
            padding: 0.375rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .settings-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        textarea::placeholder {
            color: #adb5bd !important;
        }
        
        textarea.form-control {
            color: #adb5bd;
        }
        
        textarea.form-control:focus {
            color: #212529;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="settings-card p-4">
                    <h2 class="mb-4">DataMatrix Generator</h2>
                    
                    <div class="row">
                        <!-- Preview Section -->
                        <div class="col-md-6 mb-4">
                            <div class="preview-box" id="box"></div>
                            <button class="btn btn-primary w-100" id="downloadBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Download PDF
                            </button>
                        </div>

                        <!-- Settings Section -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="msg" class="form-label">Enter Details</label>
                                <textarea id="msg" class="form-control" rows="3" placeholder="Enter the datamatrix details"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="isRectangle" checked>
                                    <label class="form-check-label" for="isRectangle">Rectangle</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="faceColor" class="form-label">Face Color</label>
                                <input type="color" id="faceColor" class="color-input" value="#000000">
                            </div>

                            <div class="mb-3">
                                <label for="backgroundColor" class="form-label">Background Color</label>
                                <input type="color" id="backgroundColor" class="color-input" value="#ffffff">
                            </div>

                            <!-- Hidden inputs for fixed values -->
                            <input type="hidden" id="dimension" value="256">
                            <input type="hidden" id="padding" value="2">
                            <input type="hidden" id="isOptimized" value="true">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calculator Link Section -->
            <div class="row justify-content-center mt-4">
                <div class="col-lg-10 text-center">
                    <a href="https://docs.google.com/spreadsheets/d/1iSF-zmKiurlZSp4tnt2J_ZmUNPV9fH-_zj3eDHE5ovo/edit?gid=1517386867#gid=1517386867" 
                       class="btn btn-outline-secondary" 
                       target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calculator me-2" viewBox="0 0 16 16">
                            <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
                            <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/>
                        </svg>
                        DataMatrix Content Calculator
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the DataMatrix library -->
    <script src="datamatrix.js"></script>
    
    <!-- Include jsPDF library for PDF conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', function() {
            const box = document.getElementById('box');
            const msg = document.getElementById('msg');
            const dimension = document.getElementById('dimension');
            const padding = document.getElementById('padding');
            const isRectangle = document.getElementById('isRectangle');
            const isOptimized = document.getElementById('isOptimized');
            const faceColor = document.getElementById('faceColor');
            const backgroundColor = document.getElementById('backgroundColor');
            const downloadBtn = document.getElementById('downloadBtn');

            function updateDataMatrix() {
                // Clear the preview box
                while (box.firstChild) {
                    box.removeChild(box.firstChild);
                }

                // Generate new DataMatrix
                const data = {
                    msg: msg.value,
                    dim: parseInt(dimension.value),
                    rct: isRectangle.checked ? 1 : 0,
                    pad: parseInt(padding.value),
                    pal: [faceColor.value, backgroundColor.value],
                    vrb: isOptimized.checked ? 0 : 1
                };

                try {
                    const dataMatrix = DATAMatrix(data);
                    box.appendChild(dataMatrix);
                } catch (error) {
                    console.error('Error generating DataMatrix:', error);
                }
            }

            function downloadPDF() {
                const { jsPDF } = window.jspdf;
                const svg = box.querySelector('svg');
                const svgData = new XMLSerializer().serializeToString(svg);
                
                // Create a canvas to render the SVG
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Create an image from SVG
                const img = new Image();
                img.onload = function() {
                    // Define barcode dimensions and margins
                    const widthScaleFactor = 1.10;  // Perfect for width
                    const heightScaleFactor = 1.27; // Increased for height
                    const barcodeWidth = 17 * widthScaleFactor;   // Compensated width
                    const barcodeHeight = 6 * heightScaleFactor;  // Compensated height
                    const margin = 10; // 10mm margin
                    
                    // Calculate page dimensions
                    const pageWidth = barcodeWidth + (margin * 2);
                    const pageHeight = barcodeHeight + (margin * 2);
                    
                    // Create PDF with custom size (barcode + margins)
                    const pdf = new jsPDF({
                        orientation: pageWidth > pageHeight ? 'landscape' : 'portrait',
                        unit: 'mm',
                        format: [Math.max(pageWidth, pageHeight), Math.min(pageWidth, pageHeight)]
                    });
                    
                    // Set canvas size for high resolution
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw SVG
                    ctx.drawImage(img, 0, 0);
                    
                    // Calculate centering
                    const xOffset = (pdf.internal.pageSize.getWidth() - barcodeWidth) / 2;
                    const yOffset = (pdf.internal.pageSize.getHeight() - barcodeHeight) / 2;
                    
                    // Add the image to PDF centered
                    pdf.addImage(
                        canvas.toDataURL('image/png'),
                        'PNG',
                        xOffset,
                        yOffset,
                        barcodeWidth,
                        barcodeHeight
                    );
                    
                    // Download the PDF
                    pdf.save(`datamatrix-${new Date().toISOString().slice(0, 19).replace(/[:]/g, '')}.pdf`);
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            }

            // Event listeners
            msg.addEventListener('input', updateDataMatrix);
            isRectangle.addEventListener('change', updateDataMatrix);
            faceColor.addEventListener('change', updateDataMatrix);
            backgroundColor.addEventListener('change', updateDataMatrix);
            downloadBtn.addEventListener('click', downloadPDF);

            // Clear initial message when focused
            msg.addEventListener('focus', function() {
                if (msg.value === 'Enter the datamatrix details') {
                    msg.value = '';
                }
            });

            // Restore placeholder if left empty
            msg.addEventListener('blur', function() {
                if (msg.value.trim() === '') {
                    msg.value = 'Enter the datamatrix details';
                }
            });

            // Initial generation
            msg.value = 'Enter the datamatrix details';
            updateDataMatrix();
        });
    </script>
</body>
</html>